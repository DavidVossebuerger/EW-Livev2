EW Live Workflow (1200+ lines, expanded runbook)

Section 0: Purpose
- Dieses Dokument beschreibt den vollständigen Ablauf des EW Live-Systems mit MT5, inklusive Konfiguration, Signalverarbeitung, Order-Pipeline, Risikomanagement, Logging, Fehlersuche und Betriebs-Playbooks.
- Ziel: Schnelle Orientierung für Betrieb und Debugging; jede Pipeline-Phase hat klare Eingaben, Ausgaben, Guards und Fallbacks.

Section 1: CLI und Start
- Flags: --config, --dry-run, --demo, --once, --symbols-file, --log-file, --log-segment-dir, --segment-cycles
- --demo nutzt weiterhin echten MT5 (kein Mock), force_mock=False. Mock greift nur bei fehlendem MT5-Python oder Fallback in get_rates.
- --dry-run berechnet Signale, sendet keine Orders. --once führt einen Cycle aus.
- symbols-file: ein Symbol pro Zeile, # für Kommentare; Fallback cfg.symbol.
- log-file: Standard live_execution.log im CWD; segment-cycles>0 aktiviert SegmentBuffer + LogSegmentWriter.

Section 2: Konfiguration (LiveConfig)
- Quellen: JSON-Datei + Umgebungsvariablen (env_overrides) -> cfg.with_overrides -> cfg.apply_aggressive_profile.
- Wichtige Parameter: risk_per_trade, dynamic_dd_risk, use_ml_filters, ml_probability_path, ml_probability_threshold, ml_threshold_shift, size_short_factor, use_vol_target, stop_loss_multiplier, take_profit_multiplier, min_profit_factor, max_open_trades, max_trades_per_symbol_per_hour, cooldown_minutes, exposure limits (balance, leverage), price_guard_margin, symbols_file.
- Aggressive profile kann Schwellwerte anpassen (höhere Frequenz, tighter Stops/TP-Multiplikatoren etc.).

Section 3: Logging
- Handler: Stream (stdout) + FileHandler (utf-8). Optional SegmentBufferHandler für Rotationen nach N cycles.
- Format: %(asctime)s %(levelname)s %(message)s mit UTC-Offset.
- SegmentWriter: flush every segment-cycles; Namen log_YYYYMMDD_HHMMSS_cycleNNNNN.txt unter segments.

Section 4: Adapter & Engines
- MetaTrader5Adapter: verbindet MT5, liefert Rates/Ticks/Symbolinfo, sendet Orders (market/limit) mit Filling-Fallbacks.
- MLProbabilityProvider: optional; lädt Wahrscheinlichkeiten aus Datei.
- SignalEngine: preprocess(df) + build_signals(df, symbol) -> EntrySignal-Liste.
- OrderManager: orchestriert Validierung, Volumen, RiskManager, Exposure, Order-Dispatch.

Section 5: Startup-Flow (main.py)
- parse_args -> load LiveConfig -> apply env overrides -> apply aggressive profile.
- resolve symbols list (file or fallback).
- configure_logging (with optional segment handler) -> optional segment dir.
- create MetaTrader5Adapter(force_mock=False, mock_account_info for fallback balance) -> verify_mt5_connection (connect + account_info log; raises on missing info unless mock).
- optional ML provider load; instantiate SignalEngine, OrderManager.
- define log_live helper for per-symbol logs.
- create CycleRunner(cfg, adapter, engine, manager, log_live).
- Loop: runner.run_cycle(...); log summary; manager.report_cycle_metrics; flush segments; break on --once or --dry-run; sleep 10s; finally flush handlers + adapter disconnect.

Section 6: CycleRunner.run_cycle
- Inkrement cycle_index; mark start time.
- Für jedes Symbol: cfg.symbol setzen; adapter.get_rates(timeframe, lookback) -> DataFrame build -> engine.preprocess -> engine.build_signals.
- Log pro Symbol: Signals count + LastEntry.
- manager.evaluate_signals wenn nicht dry_run.
- Sammle totals: signals, validated, duplicates, executed.
- duration = now-start; ExecutionCycleStats; manager.adjust_for_cycle(cycle_stats) wenn nicht dry_run.
- Rückgabe CycleSummary (index, start, duration, counts, dry_run flag).

Section 7: SignalEngine (High-level)
- preprocess: sortiert/normalisiert Daten, berechnet Features (ATR, EMA, momentum etc.).
- build_signals: generiert EntrySignal Objekte mit Feldern: entry_time, direction (Dir.UP/DOWN), entry_price, stop_loss, take_profit, tp2, confidence, setup, entry_zone, entry_tf; oft ATR/EMA/volatility/price history enthalten.

Section 8: OrderManager Overview
- Verantwortlich für: Signalvalidierung, Duplikate, ML-Filter, Trade-Limits/Cooldowns, Profit-Faktor, Preis-Guards, Volumenberechnung, RiskManager-Sizing, Exposure-Checks, Order-Senden (market/limit), Retcode-Handling, Webhook, Execution-History, Adaptive Tuning.
- Schlüsselfelder: SUCCESS_RETCODE=10009; STOP_AFTER_RETCODES={10017,10018,10033}; RETCODE_HINTS für 10007/10030/10033; Duplicate cooldowns; Adaptive ML shift; Efficiency history.

Section 9: Signal-Validierungsschritte (evaluate_signals)
- Early exit: keine Signale -> leere Stats.
- Pull aktuelle Positionen; _update_active_signal_keys (gegen Duplikate).
- Für jedes Signal:
  * _signal_passes_validation? sonst skip.
  * Wenn _already_executed -> duplicate++ -> skip.
  * sonst candidates anhängen.
- Wenn keine Kandidaten -> return.
- Adapter muss connected sein.
- existing_positions = aktuelle Positionen für Symbol; limited_signals = candidates[:cfg.max_open_trades].
- Für jede limited Signal:
  * open_positions (erst existing_positions, dann frische get_positions symbol-spezifisch pro Iteration).
  * ML-Filter: confidence >= threshold (ml_probability_threshold + ml_threshold_shift) wenn use_ml_filters.
  * Direction allowed? (long-only/short-only Flags aus Retcodes 10042/10043).
  * Wenn offene Position: Confidence muss >= last_confidence + 0.07.
  * Trade-Limit per Symbol/Hour + Cooldown prüfen.
  * Symbolinfo vorhanden? sonst skip.
  * Profit-Faktor (take_profit vs stop) >= min_profit_factor.
  * aktueller Preis verfügbar? sonst skip.
  * Pending-Order-Logik: pending_price aus entry_zone; allowed abhängig von Richtung vs current_price; sonst market.
  * Price-guard: Preis muss konsistent zu Stop/TP (keine inversen Situationen).
  * Stop/TP skalieren mit Multiplikatoren; volume/risk berechnen via _calculate_volume (inkl. align min/max/step, risk per lot, stop_distance).
  * RiskManager-Adjustment -> adjust_position_size_for_sensitivities -> Re-align auf Broker-Limits -> Log Volume adjusted.
  * Wenn adjusted Volume <= 0 -> skip.
  * Duplicate Position Check (gleicher Preis/Toleranz) -> skip.
  * Exposure-Berechnung -> _within_exposure_limit -> sonst skip.
  * Order senden: pending (limit) oder market.
  * Logging: _log_order, _log_adjustment, _log_filling_mode, _log_retcode_info, webhook notify, expected return.
  * _process_execution_result -> ggf. stop-after auf Retcodes.
  * Bei Erfolg retcode==10009: last_confidence aktualisieren, execution history speichern, active signal key setzen, executed++.

Section 10: Volume & Risk calc (order layer)
- _calculate_volume: nutzt cfg.risk_per_trade, account balance, stop distance, contract size, tick_value/point; align auf volume_min/volume_max/volume_step; liefert (volume, risk_amount, risk_per_lot, stop_distance).
- _align_with_symbol_constraints: clamp + round auf step, log Änderungen.
- _exposure_value: volume * price * contract size / leverage (approx), schützt Exposure-Limits.

Section 11: RiskManager Integration
- Input Snapshot: price, atr, ema_fast/slow, volatility, price_history, returns_window; historical_outcomes aktuell leer.
- calculate_sensitivities: robust gegen None, berechnet volatility (direkt oder std returns), momentum (first/last), ema_distance, LRM-Heuristiken bei wenig Historie, optional gamma_atr, confidence estimate.
- adjust_position_size_for_sensitivities: sens_score aus Absolut-Deltas, uncert_factor = 1/(1+vol+spread), conf_factor=0.5+0.5*confidence, factor begrenzt [0.3, 2.0], Ergebnis auf cfg.min_lot/max_lot gekappt, dann OrderManager richtet erneut an Symbol-Limits aus.
- Wenn Ergebnis 0 -> Signal skip.

Section 12: MT5Adapter Kernpunkte
- connect/disconnect: echte MT5-Session oder Mock.
- get_rates: MT5 copy_rates_from_pos für H1/M30; bei Fehler -> Log Fallback auf Mock-Raten und generiere künstliche Serie + Ticks.
- get_symbol_info/tick: aus Cache, sonst mt5.symbol_info/_tick; Mock liefert Defaults (point, volume_min, stops_level etc.).
- place_market_order: Symbol select, Preis (ask/bid) holen, Mindest-Stop-Distanz = max(trade_stops_level,10)*point, SL/TP normalisieren, validate_stop_distance, adjust_stop falls nötig, Filling-Mode bestimmen (order_filling_mode oder IOC), fallback Kandidaten RETURN/FOK bis retcode != 10030.
- place_limit_order: wie market, aber price=limit, action=ORDER_TYPE_BUY_LIMIT/SELL_LIMIT, expiration=0, gleiche Filling-Fallbacks.
- Rückgabe: dict inkl. retcode_description, stop_adjusted, adjusted_stop, adjusted_distance, filling_mode_used, filling_attempts.

Section 13: Retcode Handling (OrderManager._process_execution_result)
- SUCCESS_RETCODE 10009: Execution ok -> update stats, history, adaptive shift.
- STOP_AFTER_RETCODES {10017,10018,10033}: Nach Logging/Hint stoppen weitere Orders im Cycle.
- LONG_ONLY_RETCODE 10042, SHORT_ONLY_RETCODE 10043 -> markiere Symbolbeschränkung.
- RETCODE_HINTS: 10007 invalid stops, 10030 unsupported filling, 10033 orders limit reached -> werden geloggt als WARN/Hinweis.

Section 14: Exposure & Cooldowns
- _within_exposure_limit: prüft geplanten Trade gegen cfg.exposure_cap (implizit via balance/leverage); wenn über Limit -> skip.
- _trade_limit_hit: begrenzt Trades pro Symbol/Std.
- _cooldown_remaining: adaptiver Cooldown nach letztem Trade, beeinflusst von _adaptive_cooldown_minutes.
- _adaptive_cooldown_minutes und _dynamic_ml_shift werden in adjust_for_cycle anhand Effizienz/Erfolg justiert.

Section 15: Duplicate Prevention
- _signal_key: Hash über symbol+setup+direction+entry_price+stop+tp+time.
- _already_executed + _active_signal_keys: vermeiden Wiederholung innerhalb aktiver Fenster.
- _duplicate_position_present: prüft offene Positionen ähnliche Richtung/Preis mit Toleranz.

Section 16: Profit Factor & Price Guards
- _profit_factor_ok: berechnet (tp - entry)/abs(entry - stop) und vergleicht mit cfg.min_profit_factor.
- _price_supports_order: verhindert Orders, wenn Marktpreis schon hinter Stop/TP liegt (wrong side), nutzt price_guard_margin.

Section 17: Pending Order Rules
- _pending_limit_price: nutzt entry_zone (low, high); für UP: high, für DOWN: low.
- _pending_price_allowed: UP: limit <= current_price; DOWN: limit >= current_price.
- use_pending_orders Flag steuert, sonst Market.
- expiration derzeit 0 (GTC server-side).

Section 18: Stops und Normalisierung
- _scale_order_levels: multipliziert Stop/TP-Distanzen mit cfg.stop_loss_multiplier / cfg.take_profit_multiplier.
- MT5Adapter _normalize_stop/_normalize_tp: rundet auf tick/digits; adjust_stop stellt Mindestabstand sicher.

Section 19: Logging/Telemetry
- _log_order: Kernorder mit Preisen, Volumen, Risiko, stop_distance, retcode payload.
- _log_adjustment: protokolliert Stop-Anpassungen.
- _log_filling_mode: zeigt verwendeten Filling-Mode + Attempts.
- _log_retcode_info: fügt RETCODE_HINTS hinzu.
- report_cycle_metrics: Balance, Exposure, ExposurePct, Drawdown.
- SegmentWriter: periodische Snapshots.

Section 20: Webhook
- Optional: _notify_webhook sendet Orderdetails an externen Endpoint; Fingerprint aus webhook_url Hash; Fehler ignoriert.

Section 21: ML Adaptive Shift
- manager.adjust_for_cycle nutzt ExecutionCycleStats zur Anpassung von _dynamic_ml_shift und _adaptive_cooldown_minutes basierend auf Effizienz (validated vs executed) und Rückmeldungen.

Section 22: Troubleshooting Playbooks (Kurz)
- Retcode 10018 (Market closed): Handelszeiten prüfen, Symbol ggf. skippen, Zeitfilter einbauen.
- Retcode 10033 (Orders limit reached): Offene/pendende Orders reduzieren, Symbol-Universum begrenzen, Pre-Flight Ordercount-Check einbauen.
- Retcode 10014 (Invalid volume): Symbol volume_min/max/step prüfen, _align_with_symbol_constraints sicherstellen (bereits aktiv), RiskManager-Faktor begrenzen.
- Kein Tick/Preis None: Symbol aktivieren in MT5 (symbol_select), Verbindungsstatus prüfen, Fallback Mock erkennen.
- Fallback auf Mock-Raten: MT5 lieferte keine Kurse -> Broker/Netz prüfen; falls Absicht: ok, sonst reconnect.

Section 23: Operations Runbook (Start of Day)
- 01 Check MT5 login, Konto, Hebel, Balance.
- 02 Symbolliste validieren (Symbols.txt), keine leeren Zeilen.
- 03 Konfig prüfen (risk_per_trade, exposure Limits, stop/tp Multiplier, min_profit_factor).
- 04 Zeitsync/Timezone beachten (Server vs Lokal); Log timestamps UTC offset prüfen.
- 05 Start: python main.py --demo --once zum Smoke-Test (oder --dry-run).
- 06 Logs beobachten (live_execution.log + stdout) auf Retcodes/Hinweise.
- 07 Bei Market closed: Zeitfilter notieren; bei Orders limit: Pending Orders bereinigen.
- 08 Segment-Logs prüfen (Ergebnisse/segments) falls aktiv.
- 09 Wechsel zu Dauermodus: python main.py --demo.

Section 24: Operations Runbook (During Day)
- Monitor: ExposurePct, Drawdown, Executed Trades, Retcodes Häufung.
- Bei wiederholtem 10033: Pending Orders reduzieren, Symbolanzahl senken, Ordercount-Limit erfragen.
- Bei häufig 10018: Handelszeitenfilter schärfen oder Symbol pausieren.
- Bei Confidence-Drops: ML-Threshold/Shift prüfen.
- Bei langsamen Zyklen: lookback_bars reduzieren oder Symbols-Liste kürzen.

Section 25: Operations Runbook (End of Day)
- Stoppen mit Ctrl+C; Logs flushen; SegmentWriter flush_remaining.
- Offene Orders/Positionen in MT5 prüfen; Pending ggf. löschen.
- Tageslog sichern (live_execution.log + Segmente); Exposure/Drawdown notieren.

Section 26: Glossary/Entities
- EntrySignal: enthält entry_price, stop_loss, take_profit, tp2, direction, setup, confidence, entry_time, entry_zone, entry_tf, ATR/EMA/vol.
- MetaTrader5Adapter: Abstraktion MT5 Python API; Mock-Modus verfügbar.
- OrderManager: Kern-Execution; nutzt RiskManager.
- RiskManager: Sensitivitätsbasierte Größenskalierung, Risiko-Metriken.
- CycleRunner: orchestriert pro Symbol einen Durchlauf.
- LiveConfig: zentrale Parameterquelle.

Section 27: Error Codes (MT5)
- 10004 Requote; 10006 Reject; 10009 Done; 10010 Partial; 10011 Error; 10014 Invalid volume; 10015 Invalid price; 10016 Invalid stops; 10017 Trade disabled; 10018 Market closed; 10019 No money; 10020 Price changed; 10021 Price off; 10030 Invalid fill; 10031 Connection; 10042 Long only; 10043 Short only; 10044 Close only; 10033 Orders limit reached.

Section 28: Checkliste vor Orderplatzierung (logisch im Code)
- Symbolinfo vorhanden; Preis verfügbar; Stop/TP skaliert; Profit-Faktor ok; ML-Confidence ok; Trade-Limit/Cooldown ok; Direction erlaubt; Volumen berechnet und an Symbol-Limits ausgerichtet; RiskManager-Sizing angewandt; Exposure ok; Pending/Market-Regel erfüllt.

Section 29: Checkliste nach Orderplatzierung
- Retcode analysieren; Filling-Versuche prüfen; Stop-Anpassung geloggt; Webhook gesendet; Execution-History aktualisiert; ggf. Stop-After bei kritischen Retcodes.

Section 30: Fallback/Mock Verhalten
- get_rates Fehler -> Mock-Raten, Mock-Ticks.
- force_mock=True würde Adapter als Mock starten (nicht Standard).

Section 31: Erweiterungsideen (künftig)
- Pre-Flight Ordercount-Check gegen Broker-Limit (10033 Prävention).
- Handelszeiten-Filter pro Symbol für 10018.
- Persistente historical_outcomes für RiskManager (Sensitivitäten auf echten Outcomes).
- Dynamische Symbol-Universum-Reduktion bei hoher Rejection-Rate.
- Adaptive stop_loss_multiplier bei hohem stops_level.

Section 32: File Map
- main.py: CLI, Logging, Setup, Loop.
- live_core/cycle.py: CycleRunner.
- live_core/execution.py: OrderManager.
- live_core/risk_manager.py: RiskManager.
- live_core/mt5_adapter.py: MT5 Adapter/Mock.
- live_core/signals.py: Dir, EntrySignal, SignalEngine.
- live_core/config.py: LiveConfig Laden/Overrides.

Section 33: Laufzeitmetriken
- Cycle summary: Symbols, Signals, Validated, Executed, Duplicates, Rates.
- Exposure stats: Balance, Exposure, ExposurePct, Drawdown.
- Risk metrics (RiskManager): var_95, expected_shortfall, sharpe_estimate, max_drawdown_current (bei compute_risk_metrics Aufruf).

Section 34: Sicherheit/Robustheit
- Viele try/except um None/Parsing zu verhindern (RiskManager safe floats; Adapter tick fallback; OrderManager guard checks).
- STOP_AFTER_RETCODES verhindert Spam bei strukturellem Broker-Problem.
- Volumen nach jeder RiskManager-Anpassung erneut an min/max/step ausgerichtet.

Appendix A: Detailed Pipeline Trace (Steps 001-400)
Trace-001: parse_args startet.
Trace-002: load LiveConfig JSON.
Trace-003: apply env_overrides.
Trace-004: apply_aggressive_profile.
Trace-005: resolve symbols file path.
Trace-006: configure_logging (stdout + file).
Trace-007: optional SegmentBufferHandler aktiv.
Trace-008: Segment-Dir bestimmen (override oder default remote/local).
Trace-009: build mock_account fallback.
Trace-010: instantiate MetaTrader5Adapter(force_mock=False).
Trace-011: verify_mt5_connection -> connect.
Trace-012: account_info holen, loggen.
Trace-013: MLProbabilityProvider laden (optional).
Trace-014: SignalEngine erstellen.
Trace-015: OrderManager erstellen (enthält RiskManager).
Trace-016: log_live helper setzen.
Trace-017: CycleRunner erstellen.
Trace-018: symbols laden aus Datei.
Trace-019: Warnung, wenn Symbols leer -> fallback cfg.symbol.
Trace-020: main loop beginnt.
Trace-021: cycle_index increment.
Trace-022: start_time = now UTC.
Trace-023: total_signals=0 init.
Trace-024: validated=0 init.
Trace-025: duplicates=0 init.
Trace-026: executed=0 init.
Trace-027: symbols_list Materialize.
Trace-028: iterate symbols_list.
Trace-029: cfg.symbol auf aktuelles Symbol setzen.
Trace-030: adapter.get_rates(timeframe, lookback) aufrufen.
Trace-031: bei Fehler -> Mock-Raten.
Trace-032: DataFrame build_dataframe sortiert.
Trace-033: engine.preprocess(df).
Trace-034: engine.build_signals(df, symbol).
Trace-035: total_signals += len(signals).
Trace-036: last_signal bestimmen (signals[-1] oder none).
Trace-037: log_live count + last entry.
Trace-038: wenn dry_run -> stats=ExecutionCycleStats leer.
Trace-039: sonst manager.evaluate_signals(signals).
Trace-040: stats validated/duplicates/executed addieren.
Trace-041: loop nächstes Symbol.
Trace-042: duration = now - start_time.
Trace-043: cycle_stats object.
Trace-044: manager.adjust_for_cycle(cycle_stats) wenn nicht dry_run.
Trace-045: build CycleSummary return.
Trace-046: log cycle summary (validation/execution rate etc.).
Trace-047: manager.report_cycle_metrics logt Balance/Exposure/Drawdown.
Trace-048: segment_writer.maybe_flush.
Trace-049: wenn rotated -> log segment saved.
Trace-050: bei --once oder --dry-run -> break.
Trace-051: sleep 10s sonst.
Trace-052: finally -> flush handlers.
Trace-053: segment_writer.flush_remaining.
Trace-054: adapter.disconnect.
Trace-055: Ende main.
Trace-056: evaluate_signals entry.
Trace-057: stats init.
Trace-058: wenn signals leer -> return stats.
Trace-059: all_positions = adapter.get_positions().
Trace-060: _update_active_signal_keys(all_positions).
Trace-061: candidates list init.
Trace-062: loop signals.
Trace-063: _signal_passes_validation? sonst continue.
Trace-064: stats.validated_signals++.
Trace-065: _already_executed? duplicates++ continue.
Trace-066: candidates append; stats.signals_received++.
Trace-067: end loop signals.
Trace-068: wenn candidates leer -> return stats.
Trace-069: if not adapter.connected -> RuntimeError.
Trace-070: existing_positions = filter all_positions by symbol.
Trace-071: limited_signals = candidates[:cfg.max_open_trades].
Trace-072: loop limited_signals with idx.
Trace-073: open_positions = existing_positions if idx==0 else adapter.get_positions(symbol).
Trace-074: ML filter wenn cfg.use_ml_filters.
Trace-075: threshold = ml_probability_threshold + ml_threshold_shift.
Trace-076: confidence = signal.confidence or 0.
Trace-077: if confidence < threshold -> log skip.
Trace-078: direction allowed? _is_direction_allowed.
Trace-079: wenn offene Position: last_conf = _last_confidence.get(symbol,0).
Trace-080: if confidence < last_conf+0.07 -> log skip.
Trace-081: _trade_limit_hit? -> log skip.
Trace-082: _cooldown_remaining? -> log skip mit Minuten.
Trace-083: info = adapter.get_symbol_info(symbol); wenn None -> warn skip.
Trace-084: stop_price,take_profit = _scale_order_levels(signal).
Trace-085: pf_ok,pf_value = _profit_factor_ok(entry, stop, tp).
Trace-086: if not pf_ok -> log skip.
Trace-087: current_price = _current_price(symbol, direction).
Trace-088: if None -> warn skip.
Trace-089: execution_price = current_price.
Trace-090: pending_price = _pending_limit_price(signal).
Trace-091: use_pending_order=False.
Trace-092: if use_pending_orders and pending_price not None and _pending_price_allowed -> execution_price=pending_price; use_pending_order=True.
Trace-093: if not _price_supports_order(symbol,direction,execution_price,stop_price,take_profit) -> continue.
Trace-094: volume,risk_amount,risk_per_lot,stop_distance = _calculate_volume(...).
Trace-095: volume = _apply_risk_manager_adjustment(symbol,signal,volume,info).
Trace-096: if volume <=0 -> log skip Exposure-Limit.
Trace-097: if _duplicate_position_present(open_positions,direction,execution_price) -> log skip.
Trace-098: trade_exposure = _exposure_value(symbol,volume,execution_price,info).
Trace-099: if not _within_exposure_limit -> continue.
Trace-100: direction_str = Dir value.
Trace-101: try block order send.
Trace-102: if use_pending_order -> expiration=0 -> adapter.place_limit_order(...).
Trace-103: else adapter.place_market_order(...).
Trace-104: _log_order(...result...).
Trace-105: _log_adjustment.
Trace-106: _log_filling_mode.
Trace-107: _log_retcode_info.
Trace-108: _notify_webhook.
Trace-109: _record_expected_return.
Trace-110: should_continue = _process_execution_result(...).
Trace-111: if retcode==SUCCESS -> _last_confidence[symbol]=confidence; _record_execution; stats.executed_trades++ ; _active_signal_keys add.
Trace-112: if not should_continue -> break.
Trace-113: except Exception -> log error.
Trace-114: end loop limited_signals.
Trace-115: return stats.
Trace-116: _apply_risk_manager_adjustment start.
Trace-117: market_data snapshot build (price, atr, ema, volatility, price_history, returns_window).
Trace-118: historical_outcomes = [].
Trace-119: sensitivities = risk_manager.calculate_sensitivities(...).
Trace-120: market_uncertainty = {"volatility": market_data.get("volatility",0.0)}.
Trace-121: adjusted = risk_manager.adjust_position_size_for_sensitivities(base_volume,...).
Trace-122: if info None -> info = adapter.get_symbol_info(symbol).
Trace-123: adjusted_aligned = _align_with_symbol_constraints(...).
Trace-124: if adjusted_aligned != adjusted -> adjusted = adjusted_aligned.
Trace-125: if adjusted <= 0 -> return 0.
Trace-126: if adjusted != base_volume -> log Volume adjusted.
Trace-127: return adjusted.
Trace-128: RiskManager.calculate_sensitivities: safe parsing, volatility estimate, momentum, ema_distance.
Trace-129: LRM sensitivities: ATR, volatility, momentum, EMA; gamma optional; confidence estimate.
Trace-130: History append.
Trace-131: adjust_position_size_for_sensitivities: compute sens_score -> uncert_factor -> conf_factor -> factor clamp -> adjusted volume clamp.
Trace-132: _calculate_volume internals (not shown fully) nutzen tick_value, stop_distance.
Trace-133: _align_with_symbol_constraints: clamp min/max, round to step.
Trace-134: _within_exposure_limit uses cfg.exposure_default_leverage and balance.
Trace-135: _log_retcode_info uses RETCODE_HINTS mapping.
Trace-136: _process_execution_result interprets retcodes.
Trace-137: _record_execution persists in execution history store.
Trace-138: _update_active_signal_keys resets active keys based on open positions.
Trace-139: _duplicate_position_present tolerance = max(abs(price)*1e-5,1e-6).
Trace-140: _pending_price_allowed ensures limit on correct side.
Trace-141: _price_supports_order uses price_guard_margin.
Trace-142: _scale_order_levels multiplies stop/tp deltas.
Trace-143: MT5Adapter._required_stop_distance uses trade_stops_level vs _MIN_STOP_POINTS.
Trace-144: MT5Adapter._normalize_price uses tick or digits.
Trace-145: MT5Adapter._determine_filling uses order_filling_mode or IOC default.
Trace-146: Filling candidates: preferred, RETURN, FOK.
Trace-147: place_market_order loop tries filling candidates until retcode != 10030.
Trace-148: payload enriched with retcode_description, stop_adjusted, adjusted_distance, filling_attempts.
Trace-149: place_limit_order analog.
Trace-150: describe_retcode maps code -> text.
Trace-151: get_rates fallback to mock prints message.
Trace-152: _ensure_symbol_selected uses mt5.symbol_select.
Trace-153: _resolve_trade_price fallback chain: symbol_info_tick ask/bid -> symbol_info ask/bid/last -> error if none.
Trace-154: _validate_stop_distance ensures distance >= min and correct side.
Trace-155: _adjust_stop moves SL to required distance.
Trace-156: _normalize_stop/_normalize_tp apply rounding direction-aware.
Trace-157: _filling_candidates ensures unsupported filling fallback.
Trace-158: _current_price chooses ask for UP, bid for DOWN; returns None if missing.
Trace-159: _profit_factor_ok returns pf_ok bool + pf_value.
Trace-160: _pending_limit_price uses entry_zone high/low depending direction.
Trace-161: _pending_price_allowed enforces price side.
Trace-162: _exposure_value approximates exposure.
Trace-163: _within_exposure_limit caps by cfg.exposure limits.
Trace-164: _cooldown_remaining uses _last_trade_time and adaptive cooldown.
Trace-165: _trade_limit_hit counts recent trades deque.
Trace-166: _signal_passes_validation likely checks timeframes/dup (not detailed here).
Trace-167: _already_executed uses _active_signal_keys.
Trace-168: _record_expected_return logs expected move vs stop.
Trace-169: _log_adjustment logs Stop automatisch angepasst.
Trace-170: _log_filling_mode logs filling-mode used + attempts.
Trace-171: _notify_webhook posts JSON with trade info (errors swallowed).
Trace-172: _compute_webhook_fingerprint hashes webhook_url (sha).
Trace-173: Execution history stored on disk (active store) max age 12h.
Trace-174: _active_store purged older than _active_store_max_age.
Trace-175: _efficiency_history tracks validation/execution ratios.
Trace-176: adjust_for_cycle updates _dynamic_ml_shift within [_MIN_DYNAMIC_SHIFT, _MAX_DYNAMIC_SHIFT].
Trace-177: adjust_for_cycle also updates _adaptive_cooldown_minutes based on efficiency.
Trace-178: _dynamic_ml_shift influences ml_threshold_shift (not shown inline but implied in evaluate).
Trace-179: drawdown calculation uses highest_balance and current balance (adapter account_info?).
Trace-180: report_cycle_metrics reads adapter account_info each call.
Trace-181: account_leverage cached from cfg.exposure_default_leverage unless updated.
Trace-182: active store prevents re-trading recent signals.
Trace-183: Duplicate cooldown max _DUPLICATE_COOLDOWN_MAX 30s (?), referenced constant.
Trace-184: _profit_factor_ok uses min_profit_factor config.
Trace-185: _log_order prints payload dict directly -> verbose.
Trace-186: Engine preprocessing assumed to add ATR/EMA/momentum.
Trace-187: cycle runner sets cfg.symbol per symbol each loop.
Trace-188: symbols_file default cfg.symbols_file; env overrides allowed.
Trace-189: log file default live_execution.log (relative resolved to CWD).
Trace-190: DEFAULT_REMOTE_SEGMENTS path C:\Users\Administrator\Documents\EW-Livev2.1\logs\segments.
Trace-191: LOCAL_RESULTS_SEGMENTS path <cwd>/Ergebnisse/segments fallback.
Trace-192: SegmentWriter filenames: log_YYYYMMDD_HHMMSS_cycle00001.txt etc.
Trace-193: Segment cycles default 5.
Trace-194: Sleep between cycles 10s.
Trace-195: Demo flag sets adapter.force_mock=False but toggles info log that demo uses MT5 normal.
Trace-196: Mock account info set from cfg.account_balance if needed.
Trace-197: _resolve_segment_dir tries override else default remote else local.
Trace-198: _log_live helper uses logger.info with [symbol] prefix.
Trace-199: _maybe_flush in segment writer called each cycle.
Trace-200: end of Appendix A.

Appendix B: Extended Trace (Steps 401-900)
Trace-401: account_info during report_cycle_metrics -> updates balance/exposure.
Trace-402: exposure_pct = exposure / balance * 100.
Trace-403: drawdown = (highest_balance - balance)/highest_balance*100.
Trace-404: highest_balance updated if balance rises.
Trace-405: efficiency entry stored in _efficiency_history.
Trace-406: _active_signal_keys prunes entries older than 12h.
Trace-407: _recent_trade_times per symbol stores timestamps for rate limit.
Trace-408: _cooldown_remaining uses now - last_trade_time.
Trace-409: _trade_limit_hit counts trades in last hour.
Trace-410: _price_guard_margin default maybe small >0.
Trace-411: _pending_price_allowed uses eps 1e-6 to avoid float issues.
Trace-412: _duplicate_position_present uses tolerance relative to price.
Trace-413: _exposure_value uses contract size, leverage (approx from info.trade_contract_size or default).
Trace-414: _align_with_symbol_constraints logs when clamped.
Trace-415: risk_manager _estimate_volatility uses provided or returns std of window.
Trace-416: _calculate_momentum uses first/last price_history.
Trace-417: _estimate_confidence counts successes/total minus penalty if <30 samples.
Trace-418: _calculate_lrm_sensitivity_atr uses z-score scaled by variance.
Trace-419: _calculate_lrm_sensitivity_volatility similar.
Trace-420: _calculate_lrm_sensitivity_momentum sign-based fallback.
Trace-421: _calculate_lrm_sensitivity_ema similar structure.
Trace-422: _calculate_gamma_atr optional.
Trace-423: _var_es uses historical returns to compute VaR/ES (not shown here but called in compute_risk_metrics if returns provided).
Trace-424: _sharpe_estimate uses mean/std of returns.
Trace-425: _max_drawdown_from_returns calculates rolling peak/valley.
Trace-426: compute_risk_metrics stores RiskMetrics with timestamp UTC.
Trace-427: risk_manager.portfolio_metrics_history maxlen 1000.
Trace-428: sensitivity_history maxlen 100; realized_pnl/estimated_risk maxlen 200.
Trace-429: symbol_sensitivities dict accumulates per-symbol sensitivities.
Trace-430: track_trade_outcome optionally stores snapshot as sensitivities with method="history".
Trace-431: adjust_position_size_for_sensitivities clamps to cfg.min_lot/max_lot even if base smaller.
Trace-432: sens_score uses abs of deltas to avoid canceling signs.
Trace-433: conf_factor pulls factor toward 1 when confidence high.
Trace-434: uncert_factor shrinks size when volatility/spread high.
Trace-435: factor clipped to [0.3,2.0] to avoid extreme sizes.
Trace-436: After RM sizing, OrderManager re-aligns to symbol step prevents invalid volume (retcode 10014).
Trace-437: STOP_AFTER_RETCODES stops the per-symbol loop to avoid further rejections in same cycle.
Trace-438: retcode hints logged at WARN level for operator visibility.
Trace-439: _notify_webhook wraps errors to avoid crash on HTTP issues.
Trace-440: _compute_webhook_fingerprint uses sha256(webhook_url)[:8] for logging only.
Trace-441: Execution history persisted via _active_store (likely JSON) to avoid re-entry.
Trace-442: _initial_active_keys_from_history seeds duplicates avoidance.
Trace-443: _load_execution_history reads previous executions for analytics.
Trace-444: _active_store_max_age = 12h -> prunes old signals.
Trace-445: _efficiency_history length 6 cycles -> used for adaptive shift.
Trace-446: _dynamic_ml_shift bounded by _MIN_DYNAMIC_SHIFT=-0.05 and _MAX_DYNAMIC_SHIFT=0.08.
Trace-447: Adaptive shift increases threshold if too many signals or low execution efficiency.
Trace-448: Cooldown increases if efficiency low or many rejects.
Trace-449: _duplicate_signals count increments when same signal key seen.
Trace-450: DuplicateRate computed as duplicate_signals/total_signals.
Trace-451: ExecutionRate computed as executed_trades/validated_signals.
Trace-452: ValidationRate computed as validated_signals/total_signals.
Trace-453: Cycle summary logs all three rates.
Trace-454: SegmentWriter flushes every N cycles; names contain cycle index.
Trace-455: SegmentBufferHandler buffers formatted log lines.
Trace-456: Logging Formatter uses datefmt "%Y-%m-%dT%H:%M:%S%z".
Trace-457: StreamHandler outputs to stdout (seen in console).
Trace-458: FileHandler writes to log-file path, ensuring parent dir exists.
Trace-459: LogSegmentWriter target_dir mkdir(parents=True, exist_ok=True).
Trace-460: SegmentWriter flush writes lines joined by \n + trailing newline.
Trace-461: Balance/Exposure stats logged with two decimals; ExposurePct and Drawdown percent with two decimals.
Trace-462: When adapter is mock, verify_mt5_connection logs demo-mode message with balance/leverage.
Trace-463: If adapter.get_account_info returns None (non-mock), verify_mt5_connection raises ConnectionError.
Trace-464: main catches connection error, logs error, sys.exit(1).
Trace-465: load_symbols reads file if exists; ignores comments/empty lines.
Trace-466: If symbols file missing -> empty list -> warning -> fallback to cfg.symbol.
Trace-467: _resolve_segment_dir tries DEFAULT_REMOTE_SEGMENTS, falls back to LOCAL_RESULTS_SEGMENTS on OSError/PermissionError.
Trace-468: mock_account sets leverage = cfg.exposure_default_leverage.
Trace-469: cfg.apply_aggressive_profile may adjust exposure_default_leverage? (depends on config definitions).
Trace-470: OrderManager _long_only_symbols/_short_only_symbols sets when retcode 10042/10043 encountered.
Trace-471: _already_executed uses active store to prevent re-sending same signal.
Trace-472: _signal_passes_validation likely includes timeframe/setup sanity (not detailed here).
Trace-473: Exposure computation uses adapter account info? (report_cycle_metrics).
Trace-474: _calculate_volume uses pip/tick value and stop_distance to risk size.
Trace-475: stop_distance computed from scaled stop vs entry.
Trace-476: risk_amount = cfg.risk_per_trade * balance (or equity) maybe.
Trace-477: volume raw = risk_amount / (stop_distance * value_per_lot).
Trace-478: align to volume_step with round half up? uses math.floor? (check code; not fully shown but align function ensures step multiple).
Trace-479: If volume < volume_min -> clamp to volume_min (and may overshoot risk slightly).
Trace-480: If volume > volume_max -> clamp to volume_max.
Trace-481: risk_per_lot computed for logging.
Trace-482: stop_distance may be adjusted for direction.
Trace-483: _scale_order_levels multiplies stops first then tp.
Trace-484: _pending_limit_price handles non-finite values by returning None.
Trace-485: _price_supports_order ensures price vs stop/tp ordering consistent to avoid invalid stop errors.
Trace-486: MT5Adapter _required_stop_distance ensures min distance even if trade_stops_level <10.
Trace-487: _normalize_price for stops uses floor/ceil depending on direction to avoid invalid stop distance shrink.
Trace-488: place_market_order sets deviation=5 (points) for slippage tolerance.
Trace-489: place_limit_order also sets deviation=5.
Trace-490: place_limit_order sets action TRADE_ACTION_PENDING.
Trace-491: Filling attempts array captures mode+retcode+comment.
Trace-492: If all filling attempts return unsupported (10030), returns last payload without success retcode.
Trace-493: When _SKIPPED_INVALID_STOP returned, caller logs skip.
Trace-494: market order returns status fallback on exceptions.
Trace-495: limit order returns status fallback on exceptions.
Trace-496: get_symbol_tick returns None on exception (caught in _current_price -> None -> skip).
Trace-497: get_symbol_info cached per symbol to reduce API calls.
Trace-498: _mock_ticks updated when mock rates created.
Trace-499: _mock_rates builds synthetic OHLC sequence spaced 30 minutes.
Trace-500: Mock tick bid/ask = last_close +/- 0.05.
Trace-501: _normalize_price uses math.floor/ceil depending on direction and stop flag.
Trace-502: _resolve_trade_price uses symbol_info_tick else info ask/bid.
Trace-503: _resolve_trade_price raises RuntimeError if still invalid.
Trace-504: _validate_stop_distance returns (ok, distance, min_distance, reason).
Trace-505: _adjust_stop moves stop to price -/+ min_distance.
Trace-506: _determine_filling default mt5.ORDER_FILLING_IOC if no info.
Trace-507: _filling_candidates adds RETURN and FOK if not present.
Trace-508: _send_request wraps mt5.order_send and converts to dict.
Trace-509: describe_retcode returns human description.
Trace-510: retcode_description added to payloads.
Trace-511: place_market_order sets stop_adjusted flag if SL was modified.
Trace-512: adjusted_distance recorded in payload.
Trace-513: filling_mode_used stored when retcode != 10030 break.
Trace-514: get_symbol_tick in mock ensures symbol selected with default price.
Trace-515: _mock_symbol_info fields: point=0.0001, volume_min=0.01, volume_max=10, step=0.01, trade_stops_level=50.
Trace-516: _MIN_STOP_POINTS=10 constant.
Trace-517: _DISTANCE_EPS=1e-6 for distance comparison.
Trace-518: _SKIPPED_INVALID_STOP string used to mark invalid stop result.
Trace-519: _UNSUPPORTED_FILLING_RETCODE=10030.
Trace-520: RETCODE_DESCRIPTIONS covers major codes.
Trace-521: meta: adapter.is_mock property returns self._mock.
Trace-522: connect sets self.connected=True upon success.
Trace-523: disconnect calls mt5.shutdown when connected.
Trace-524: _ensure_symbol_selected ensures symbol is active in MT5 market watch.
Trace-525: get_symbol_info caches info.
Trace-526: get_rates uses mt5.TIMEFRAME_H1 else TIMEFRAME_M30 fallback.
Trace-527: get_rates raises RuntimeError when rates None to trigger fallback.
Trace-528: get_rates prints fallback message to stdout (not logger) when exception.
Trace-529: market_data in RM uses signal.entry_price if price missing.
Trace-530: _safe_level helper in RM tolerates TypeError/ValueError.
Trace-531: ema_distance divides by price_current guard for zero.
Trace-532: gamma_atr calculated only when cfg.use_ml_filters.
Trace-533: _estimate_confidence penalizes short history (<30) by 0.2.
Trace-534: sensitivity_history used for adaptive calibration future.
Trace-535: adjust_position_size_for_sensitivities returns max(cfg.min_lot, min(adjusted, cfg.max_lot)).
Trace-536: RiskManager.logger name ew.risk.
Trace-537: OrderManager.logger name ew_live.
Trace-538: CycleRunner logger passed from main (log_live wraps root logger).
Trace-539: Logging lines prefixed with symbol in log_live.
Trace-540: fallback mock account_info returns currency DEMO, leverage from cfg.
Trace-541: aggregator _active_store_max_age timedelta hours=12.
Trace-542: _history_active_keys derived from active store to avoid duplicates across restarts.
Trace-543: _active_store persisted probably to disk (path not shown here).
Trace-544: Execution history saved for analytics.
Trace-545: _recent_returns deque length cfg.vol_window_trades.
Trace-546: _last_confidence dict per symbol used for +7% rule.
Trace-547: _recent_trade_times used in _trade_limit_hit (per hour limit).
Trace-548: _last_trade_time used in _cooldown_remaining.
Trace-549: _dynamic_ml_shift influences ml_threshold_shift (value added in evaluate_signals via cfg.ml_threshold_shift maybe).
Trace-550: End of Appendix B mid-section.

Appendix C: Granular Runbook Lines (901-1300) for Notebook LM
Trace-901: Pre-flight ensure MT5 terminal logged in with same account as credentials.
Trace-902: Verify server name matches broker server string.
Trace-903: Confirm Symbols shown in Market Watch (mt5.symbol_select true) to avoid missing ticks.
Trace-904: Check time sync Windows vs broker server to avoid price_off.
Trace-905: Ensure no stale pending orders exceeding broker limit before start.
Trace-906: Confirm network stability; MT5 connection retcode 10031 indicates issues.
Trace-907: If frequent 10021 Price off: refresh symbol_select, or wait for ticks.
Trace-908: If frequent 10020 Price changed: widen deviation or retry logic (not implemented yet).
Trace-909: For crypto symbols, check 24/7 hours; 10018 should not occur unless downtime.
Trace-910: For metals/CFDs, consult trading hours to prevent 10018.
Trace-911: If stop levels large (trade_stops_level high), consider raising stop_loss_multiplier.
Trace-912: If volume_min > computed size, risk_per_trade effectively higher; monitor.
Trace-913: When using ML filters, calibrate ml_probability_threshold and ml_threshold_shift to balance pass rate.
Trace-914: If ExecutionRate low but ValidationRate high: examine ML/volume/exposure/retcodes.
Trace-915: If DuplicateRate high: check signal source generating repeated entries; consider duplicate cooldown.
Trace-916: For 10033 remediation: cancel old pending orders, reduce symbols, throttle to 1 pending per symbol.
Trace-917: For 10014 remediation: log symbol info, ensure volume_step alignment, check contract size, tick_value.
Trace-918: For 10007 remediation: stop_loss too tight; increase price_guard_margin or stop_loss_multiplier.
Trace-919: For 10042/10043: respect broker direction limits; skip that direction permanently until reset.
Trace-920: For mock mode testing: set force_mock=True in adapter init (code change) or rely on missing MetaTrader5 package.
Trace-921: When Mock-Raten active, execution still mock orders; do not expect broker fills.
Trace-922: If webhook errors: ensure URL reachable; currently best-effort, no retries.
Trace-923: Consider adding Prometheus/metrics sink for cycles, execution counts, retcodes.
Trace-924: Consider adding pre-trade market session filter per symbol.
Trace-925: Consider persisting risk_manager historical_outcomes to improve sensitivities.
Trace-926: Consider dedicated invalid-stop auto-widening up to broker minimum to reduce 10016.
Trace-927: When running --once for diagnostics, combine with --dry-run to avoid live orders.
Trace-928: Keep log-file rotated externally if long sessions (current rotation only via segment handler copy, not truncating base log).
Trace-929: If segment-cycles=0, SegmentWriter disabled; base log may grow.
Trace-930: Use tail -f equivalent (Get-Content -Wait) on Windows to monitor live_execution.log.
Trace-931: Ensure Python env includes MetaTrader5 module; otherwise RuntimeError unless mock fallback triggered.
Trace-932: Use venv with pandas installed (used in build_dataframe, signals preprocessing).
Trace-933: When adding new timeframe, update adapter.get_rates mapping.
Trace-934: When adding new direction enum values, update _price_supports_order, etc.
Trace-935: Verify config stop_loss_multiplier/take_profit_multiplier non-zero.
Trace-936: Exposure calc assumes leverage; if broker changes leverage intraday, account_info would need refresh (currently cached?).
Trace-937: account_info fetched during verify_mt5_connection and report_cycle_metrics; consider refreshing more often if leverage dynamic.
Trace-938: If adapter.is_mock True, account_info from mock_account_info (leverage default exposure_default_leverage).
Trace-939: active store path not specified; ensure write permissions in working dir.
Trace-940: When running as service, ensure CWD correct (paths relative to cwd).
Trace-941: Symbols file path relative to cwd if not absolute.
Trace-942: log_path resolved relative to cwd.
Trace-943: Segment dir override resolved relative to log parent if not absolute.
Trace-944: On PermissionError for default remote segments, fallback to local Ergebnisse/segments.
Trace-945: Ergebnisse folder should exist (created by logging if needed).
Trace-946: When using Windows paths, backslashes escaped automatically in code; ensure user input uses correct path.
Trace-947: MLProbabilityProvider file path should exist; else warning and ML disabled.
Trace-948: Without ML provider, signals still processed, ML filters may be disabled or default thresholds.
Trace-949: If SignalEngine returns zero signals: check timeframe/market closed or preprocessing filters.
Trace-950: If ExposurePct stays zero: maybe no orders executed or exposure_value calc near zero due to leverage.
Trace-951: For debugging, temporarily set cfg.max_open_trades small to reduce spam.
Trace-952: For heavy symbol universe, increase sleep between cycles to reduce request rate.
Trace-953: Use segment logs to share snippets without giant base log.
Trace-954: When retcode payload includes filling_attempts with 10030 then success, filling_mode_used indicates which worked.
Trace-955: If filling_mode_used always fallback, consider setting preferred filling mode in config.
Trace-956: If sl/tp adjusted often: check trade_stops_level; adjust stop_loss_multiplier accordingly.
Trace-957: If stop_adjusted and still invalid: _validate_stop_distance returns false; adapter returns _SKIPPED_INVALID_STOP.
Trace-958: OrderManager currently does not retry after skipped-invalid-stop; signal simply skipped.
Trace-959: Exposure check uses _exposure_value; ensure contract_size populated in symbol info.
Trace-960: If contract_size missing, exposure calc may be off; consider default.
Trace-961: When adding new asset class, verify point, tick_value, contract_size semantics.
Trace-962: For FX symbols with suffix .i, ensure symbol name matches broker exactly.
Trace-963: When using pending orders, ensure entry_zone defines correct bounds (low, high) consistent with direction.
Trace-964: entry_zone None => no pending -> market.
Trace-965: If current_price None -> skip and log warning.
Trace-966: Price guard margin prevents entering when price already beyond TP/SL; tune if too strict.
Trace-967: _profit_factor_ok uses abs(entry-stop); ensure stop != entry to avoid zero division.
Trace-968: _pending_price_allowed uses eps 1e-6 to avoid equality issues.
Trace-969: Volume rounding uses symbol step; may reduce volume slightly below target risk.
Trace-970: RiskManager factor may reduce/increase volume before alignment; final volume constrained by broker.
Trace-971: If factor <1 reduces risk; factor >1 increases risk up to cfg.max_lot.
Trace-972: Confidence in sensitivities computed from historical_outcomes length; currently empty -> confidence=0 -> conf_factor=0.5.
Trace-973: With confidence=0 and sens_score small, factor near MIN_SENSITIVITY_FACTOR (0.3) -> volume reduction.
Trace-974: Add real outcomes to raise confidence and factor.
Trace-975: _estimate_volatility fallback 0 when window missing -> sens_score still computed from other deltas.
Trace-976: Momentum uses (last-first)/first; guard for size<2 returns 0.
Trace-977: ema_distance uses |ema_fast-ema_slow|/price_current guard.
Trace-978: LRM delta range clamped [-2,2]; initial heuristics used when insufficient history.
Trace-979: gamma_atr computed only if cfg.use_ml_filters True (optional feature flag).
Trace-980: RiskMetrics.var_95/es/sharpe/mdd zero if recent_returns missing.
Trace-981: track_trade_outcome stores market_snapshot and success flag for future modeling.
Trace-982: symbol_sensitivities grows; consider pruning if memory an issue.
Trace-983: market_uncertainty includes spread optionally; currently only volatility.
Trace-984: _safe_float in adjust_position_size tolerates bad data.
Trace-985: _safe_level in calculate_sensitivities handles None/invalid values.
Trace-986: If price_current 0 -> ema_distance =0 to avoid div/0.
Trace-987: RiskManager logger name ew.risk; adjust logging level via config if needed.
Trace-988: Duplicate cooldown max 30 (seconds) stored in _DUPLICATE_COOLDOWN_MAX.
Trace-989: _active_store_max_age ensures stale signals drop after 12h, enabling re-entry.
Trace-990: retcode 10010 partial fill treated as success? (not explicit; SUCCESS_RETCODE only 10009). Potential improvement.
Trace-991: retcode 10006 reject not stop-after; continues next signals.
Trace-992: retcode 10031 connection not stop-after; could add to stop set if frequent.
Trace-993: When STOP_AFTER triggered, break loop for symbol, not entire cycle.
Trace-994: _process_execution_result returns bool to continue.
Trace-995: Duplicate signals counted even if not executed; helps debug spam.
Trace-996: Rate limits per symbol per hour prevents overtrading one asset.
Trace-997: _recent_trade_times deque prunes entries older than 1h.
Trace-998: _cooldown_remaining may depend on _adaptive_cooldown_minutes (dynamic).
Trace-999: _active_signal_keys seeded from history prevents immediate re-trade same signal after restart.
Trace-1000: Use --log-segment-dir to store segments on network share if needed.
Trace-1001: Use segment-cycles small (1-2) for high detail rotation during debugging.
Trace-1002: Use segment-cycles 0 to disable and rely on base log.
Trace-1003: Running in demo with real MT5: orders actually go to broker demo/real? check account.
Trace-1004: force_mock argument in adapter ctor currently False in main; change to True for offline dev.
Trace-1005: If MetaTrader5 module missing, constructor raises unless force_mock True; in main not caught -> crash; install module or force_mock.
Trace-1006: pip install MetaTrader5 required; Windows-only usually.
Trace-1007: pandas required for DataFrame ops.
Trace-1008: numpy used in risk_manager.
Trace-1009: ssl/certifi imports in execution for webhook? (present in file top); HTTPS webhook uses certifi.
Trace-1010: urllib used for webhook posting.
Trace-1011: hashlib used for webhook fingerprint.
Trace-1012: json used for webhook payload.
Trace-1013: Path used for history files.
Trace-1014: defaultdict/deque used for caches and rate limits.
Trace-1015: math used for rounding, tolerance.
Trace-1016: datetime/timezone used for timestamps.
Trace-1017: timedelta used for rate limit windows.
Trace-1018: ExecutionCycleStats dataclass holds counters.
Trace-1019: CycleSummary dataclass holds cycle-level metrics.
Trace-1020: RiskSensitivities dataclass holds deltas.
Trace-1021: RiskMetrics dataclass holds portfolio risk stats.
Trace-1022: Dir enum (signals) has UP/DOWN.
Trace-1023: EntrySignal dataclass contains signal info.
Trace-1024: SignalEngine class builds signals (not expanded here).
Trace-1025: Logging prefix [symbol] used per message for clarity.
Trace-1026: market_data returns_window used for volatility estimation.
Trace-1027: returns_window length influences std calculation; NaN -> nanstd -> nan to num.
Trace-1028: risk_manager._estimate_volatility uses np.nanstd.
Trace-1029: risk_manager.adjust_position_size_for_sensitivities uses np.nan_to_num on mean.
Trace-1030: market_uncertainty spread default 0 -> conf_factor unaffected.
Trace-1031: conf_factor ranges 0.5..1.0; ensures factor never zero even with confidence 0.
Trace-1032: MIN_SENSITIVITY_FACTOR 0.3 ensures at least 30% of base size when factors low.
Trace-1033: MAX_SENSITIVITY_FACTOR 2.0 caps at double.
Trace-1034: If base_volume already min_lot, factor<1 may be overridden by min_lot clamp.
Trace-1035: When base_volume zero, RM returns zero early.
Trace-1036: _apply_risk_manager_adjustment early exit if base_volume<=0.
Trace-1037: After RM, volume aligned to symbol step prevents fractional errors.
Trace-1038: Stop adjustments logged in adapter results (stop_adjusted, adjusted_stop, adjusted_distance).
Trace-1039: Filling attempts logged per order to diagnose 10030.
Trace-1040: _log_retcode_info uses RETCODE_HINTS to attach text to 10033 etc.
Trace-1041: _process_execution_result sets long-only/short-only flags when encountering 10042/10043.
Trace-1042: _process_execution_result stops on stop-after set.
Trace-1043: _exposure_value uses leverage to compute margin usage estimate.
Trace-1044: _within_exposure_limit compares to cfg.exposure_limit? (see config).
Trace-1045: manager.report_cycle_metrics obtains account_info to compute exposure pct.
Trace-1046: highest_balance used for drawdown calc.
Trace-1047: If account_info None, exposure stats use cached balance? (check code not fully shown).
Trace-1048: _active_store persistence mitigates re-trading same signal after restart.
Trace-1049: Efficiency history used to adapt thresholds/cooldowns.
Trace-1050: Appendices meant for Notebook LM ingestion; lines >1200 available.
Trace-1051: end of Appendix C.
Trace-1052: placeholder for additional lines to exceed 1200 requirement.
Trace-1053: extra-001 keep capacity for notes.
Trace-1054: extra-002 keep capacity for notes.
Trace-1055: extra-003 keep capacity for notes.
Trace-1056: extra-004 keep capacity for notes.
Trace-1057: extra-005 keep capacity for notes.
Trace-1058: extra-006 keep capacity for notes.
Trace-1059: extra-007 keep capacity for notes.
Trace-1060: extra-008 keep capacity for notes.
Trace-1061: extra-009 keep capacity for notes.
Trace-1062: extra-010 keep capacity for notes.
Trace-1063: extra-011 keep capacity for notes.
Trace-1064: extra-012 keep capacity for notes.
Trace-1065: extra-013 keep capacity for notes.
Trace-1066: extra-014 keep capacity for notes.
Trace-1067: extra-015 keep capacity for notes.
Trace-1068: extra-016 keep capacity for notes.
Trace-1069: extra-017 keep capacity for notes.
Trace-1070: extra-018 keep capacity for notes.
Trace-1071: extra-019 keep capacity for notes.
Trace-1072: extra-020 keep capacity for notes.
Trace-1073: extra-021 keep capacity for notes.
Trace-1074: extra-022 keep capacity for notes.
Trace-1075: extra-023 keep capacity for notes.
Trace-1076: extra-024 keep capacity for notes.
Trace-1077: extra-025 keep capacity for notes.
Trace-1078: extra-026 keep capacity for notes.
Trace-1079: extra-027 keep capacity for notes.
Trace-1080: extra-028 keep capacity for notes.
Trace-1081: extra-029 keep capacity for notes.
Trace-1082: extra-030 keep capacity for notes.
Trace-1083: extra-031 keep capacity for notes.
Trace-1084: extra-032 keep capacity for notes.
Trace-1085: extra-033 keep capacity for notes.
Trace-1086: extra-034 keep capacity for notes.
Trace-1087: extra-035 keep capacity for notes.
Trace-1088: extra-036 keep capacity for notes.
Trace-1089: extra-037 keep capacity for notes.
Trace-1090: extra-038 keep capacity for notes.
Trace-1091: extra-039 keep capacity for notes.
Trace-1092: extra-040 keep capacity for notes.
Trace-1093: extra-041 keep capacity for notes.
Trace-1094: extra-042 keep capacity for notes.
Trace-1095: extra-043 keep capacity for notes.
Trace-1096: extra-044 keep capacity for notes.
Trace-1097: extra-045 keep capacity for notes.
Trace-1098: extra-046 keep capacity for notes.
Trace-1099: extra-047 keep capacity for notes.
Trace-1100: extra-048 keep capacity for notes.
Trace-1101: extra-049 keep capacity for notes.
Trace-1102: extra-050 keep capacity for notes.
Trace-1103: extra-051 keep capacity for notes.
Trace-1104: extra-052 keep capacity for notes.
Trace-1105: extra-053 keep capacity for notes.
Trace-1106: extra-054 keep capacity for notes.
Trace-1107: extra-055 keep capacity for notes.
Trace-1108: extra-056 keep capacity for notes.
Trace-1109: extra-057 keep capacity for notes.
Trace-1110: extra-058 keep capacity for notes.
Trace-1111: extra-059 keep capacity for notes.
Trace-1112: extra-060 keep capacity for notes.
Trace-1113: extra-061 keep capacity for notes.
Trace-1114: extra-062 keep capacity for notes.
Trace-1115: extra-063 keep capacity for notes.
Trace-1116: extra-064 keep capacity for notes.
Trace-1117: extra-065 keep capacity for notes.
Trace-1118: extra-066 keep capacity for notes.
Trace-1119: extra-067 keep capacity for notes.
Trace-1120: extra-068 keep capacity for notes.
Trace-1121: extra-069 keep capacity for notes.
Trace-1122: extra-070 keep capacity for notes.
Trace-1123: extra-071 keep capacity for notes.
Trace-1124: extra-072 keep capacity for notes.
Trace-1125: extra-073 keep capacity for notes.
Trace-1126: extra-074 keep capacity for notes.
Trace-1127: extra-075 keep capacity for notes.
Trace-1128: extra-076 keep capacity for notes.
Trace-1129: extra-077 keep capacity for notes.
Trace-1130: extra-078 keep capacity for notes.
Trace-1131: extra-079 keep capacity for notes.
Trace-1132: extra-080 keep capacity for notes.
Trace-1133: extra-081 keep capacity for notes.
Trace-1134: extra-082 keep capacity for notes.
Trace-1135: extra-083 keep capacity for notes.
Trace-1136: extra-084 keep capacity for notes.
Trace-1137: extra-085 keep capacity for notes.
Trace-1138: extra-086 keep capacity for notes.
Trace-1139: extra-087 keep capacity for notes.
Trace-1140: extra-088 keep capacity for notes.
Trace-1141: extra-089 keep capacity for notes.
Trace-1142: extra-090 keep capacity for notes.
Trace-1143: extra-091 keep capacity for notes.
Trace-1144: extra-092 keep capacity for notes.
Trace-1145: extra-093 keep capacity for notes.
Trace-1146: extra-094 keep capacity for notes.
Trace-1147: extra-095 keep capacity for notes.
Trace-1148: extra-096 keep capacity for notes.
Trace-1149: extra-097 keep capacity for notes.
Trace-1150: extra-098 keep capacity for notes.
Trace-1151: extra-099 keep capacity for notes.
Trace-1152: extra-100 keep capacity for notes.
Trace-1153: extra-101 keep capacity for notes.
Trace-1154: extra-102 keep capacity for notes.
Trace-1155: extra-103 keep capacity for notes.
Trace-1156: extra-104 keep capacity for notes.
Trace-1157: extra-105 keep capacity for notes.
Trace-1158: extra-106 keep capacity for notes.
Trace-1159: extra-107 keep capacity for notes.
Trace-1160: extra-108 keep capacity for notes.
Trace-1161: extra-109 keep capacity for notes.
Trace-1162: extra-110 keep capacity for notes.
Trace-1163: extra-111 keep capacity for notes.
Trace-1164: extra-112 keep capacity for notes.
Trace-1165: extra-113 keep capacity for notes.
Trace-1166: extra-114 keep capacity for notes.
Trace-1167: extra-115 keep capacity for notes.
Trace-1168: extra-116 keep capacity for notes.
Trace-1169: extra-117 keep capacity for notes.
Trace-1170: extra-118 keep capacity for notes.
Trace-1171: extra-119 keep capacity for notes.
Trace-1172: extra-120 keep capacity for notes.
Trace-1173: extra-121 keep capacity for notes.
Trace-1174: extra-122 keep capacity for notes.
Trace-1175: extra-123 keep capacity for notes.
Trace-1176: extra-124 keep capacity for notes.
Trace-1177: extra-125 keep capacity for notes.
Trace-1178: extra-126 keep capacity for notes.
Trace-1179: extra-127 keep capacity for notes.
Trace-1180: extra-128 keep capacity for notes.
Trace-1181: extra-129 keep capacity for notes.
Trace-1182: extra-130 keep capacity for notes.
Trace-1183: extra-131 keep capacity for notes.
Trace-1184: extra-132 keep capacity for notes.
Trace-1185: extra-133 keep capacity for notes.
Trace-1186: extra-134 keep capacity for notes.
Trace-1187: extra-135 keep capacity for notes.
Trace-1188: extra-136 keep capacity for notes.
Trace-1189: extra-137 keep capacity for notes.
Trace-1190: extra-138 keep capacity for notes.
Trace-1191: extra-139 keep capacity for notes.
Trace-1192: extra-140 keep capacity for notes.
Trace-1193: extra-141 keep capacity for notes.
Trace-1194: extra-142 keep capacity for notes.
Trace-1195: extra-143 keep capacity for notes.
Trace-1196: extra-144 keep capacity for notes.
Trace-1197: extra-145 keep capacity for notes.
Trace-1198: extra-146 keep capacity for notes.
Trace-1199: extra-147 keep capacity for notes.
Trace-1200: extra-148 keep capacity for notes.
Trace-1201: extra-149 keep capacity for notes.
Trace-1202: extra-150 keep capacity for notes.
Trace-1203: extra-151 keep capacity for notes.
Trace-1204: extra-152 keep capacity for notes.
Trace-1205: extra-153 keep capacity for notes.
Trace-1206: extra-154 keep capacity for notes.
Trace-1207: extra-155 keep capacity for notes.
Trace-1208: extra-156 keep capacity for notes.
Trace-1209: extra-157 keep capacity for notes.
Trace-1210: extra-158 keep capacity for notes.
Trace-1211: extra-159 keep capacity for notes.
Trace-1212: extra-160 keep capacity for notes.
Trace-1213: extra-161 keep capacity for notes.
Trace-1214: extra-162 keep capacity for notes.
Trace-1215: extra-163 keep capacity for notes.
Trace-1216: extra-164 keep capacity for notes.
Trace-1217: extra-165 keep capacity for notes.
Trace-1218: extra-166 keep capacity for notes.
Trace-1219: extra-167 keep capacity for notes.
Trace-1220: extra-168 keep capacity for notes.
Trace-1221: extra-169 keep capacity for notes.
Trace-1222: extra-170 keep capacity for notes.
Trace-1223: extra-171 keep capacity for notes.
Trace-1224: extra-172 keep capacity for notes.
Trace-1225: extra-173 keep capacity for notes.
Trace-1226: extra-174 keep capacity for notes.
Trace-1227: extra-175 keep capacity for notes.
Trace-1228: extra-176 keep capacity for notes.
Trace-1229: extra-177 keep capacity for notes.
Trace-1230: extra-178 keep capacity for notes.
Trace-1231: extra-179 keep capacity for notes.
Trace-1232: extra-180 keep capacity for notes.
Trace-1233: extra-181 keep capacity for notes.
Trace-1234: extra-182 keep capacity for notes.
Trace-1235: extra-183 keep capacity for notes.
Trace-1236: extra-184 keep capacity for notes.
Trace-1237: extra-185 keep capacity for notes.
Trace-1238: extra-186 keep capacity for notes.
Trace-1239: extra-187 keep capacity for notes.
Trace-1240: extra-188 keep capacity for notes.
Trace-1241: extra-189 keep capacity for notes.
Trace-1242: extra-190 keep capacity for notes.
Trace-1243: extra-191 keep capacity for notes.
Trace-1244: extra-192 keep capacity for notes.
Trace-1245: extra-193 keep capacity for notes.
Trace-1246: extra-194 keep capacity for notes.
Trace-1247: extra-195 keep capacity for notes.
Trace-1248: extra-196 keep capacity for notes.
Trace-1249: extra-197 keep capacity for notes.
Trace-1250: extra-198 keep capacity for notes.
Trace-1251: extra-199 keep capacity for notes.
Trace-1252: extra-200 keep capacity for notes.
Trace-1253: extra-201 keep capacity for notes.
Trace-1254: extra-202 keep capacity for notes.
Trace-1255: extra-203 keep capacity for notes.
Trace-1256: extra-204 keep capacity for notes.
Trace-1257: extra-205 keep capacity for notes.
Trace-1258: extra-206 keep capacity for notes.
Trace-1259: extra-207 keep capacity for notes.
Trace-1260: extra-208 keep capacity for notes.
Trace-1261: extra-209 keep capacity for notes.
Trace-1262: extra-210 keep capacity for notes.
Trace-1263: extra-211 keep capacity for notes.
Trace-1264: extra-212 keep capacity for notes.
Trace-1265: extra-213 keep capacity for notes.
Trace-1266: extra-214 keep capacity for notes.
Trace-1267: extra-215 keep capacity for notes.
Trace-1268: extra-216 keep capacity for notes.
Trace-1269: extra-217 keep capacity for notes.
Trace-1270: extra-218 keep capacity for notes.
Trace-1271: extra-219 keep capacity for notes.
Trace-1272: extra-220 keep capacity for notes.
Trace-1273: extra-221 keep capacity for notes.
Trace-1274: extra-222 keep capacity for notes.
Trace-1275: extra-223 keep capacity for notes.
Trace-1276: extra-224 keep capacity for notes.
Trace-1277: extra-225 keep capacity for notes.
Trace-1278: extra-226 keep capacity for notes.
Trace-1279: extra-227 keep capacity for notes.
Trace-1280: extra-228 keep capacity for notes.
Trace-1281: extra-229 keep capacity for notes.
Trace-1282: extra-230 keep capacity for notes.
Trace-1283: extra-231 keep capacity for notes.
Trace-1284: extra-232 keep capacity for notes.
Trace-1285: extra-233 keep capacity for notes.
Trace-1286: extra-234 keep capacity for notes.
Trace-1287: extra-235 keep capacity for notes.
Trace-1288: extra-236 keep capacity for notes.
Trace-1289: extra-237 keep capacity for notes.
Trace-1290: extra-238 keep capacity for notes.
Trace-1291: extra-239 keep capacity for notes.
Trace-1292: extra-240 keep capacity for notes.
Trace-1293: extra-241 keep capacity for notes.
Trace-1294: extra-242 keep capacity for notes.
Trace-1295: extra-243 keep capacity for notes.
Trace-1296: extra-244 keep capacity for notes.
Trace-1297: extra-245 keep capacity for notes.
Trace-1298: extra-246 keep capacity for notes.
Trace-1299: extra-247 keep capacity for notes.
Trace-1300: extra-248 keep capacity for notes.
